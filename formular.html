<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Formular ausfüllen - 37.3-Prüfungsassistent</title>
    <meta name="description" content="37.3-Prüfungsformular ausfüllen und bearbeiten">
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Custom Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Animation Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js"></script>
    
    <!-- PDF-Lib for PDF Handling -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf-lib/1.17.1/pdf-lib.min.js"></script>
    
    <!-- Custom Styles -->
    <style>
        :root {
            --primary-blue: #2563EB;
            --secondary-gray: #6B7280;
            --accent-green: #10B981;
            --bg-light: #F9FAFB;
        }
        
        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        
        .glass-effect {
            background: rgba(255, 255, 255, 0.25);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.18);
        }
        
        .form-section {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            transition: all 0.3s ease;
        }
        
        .form-section.active {
            border-color: var(--primary-blue);
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
        }
        
        .form-input {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
            border: 2px solid transparent;
            transition: all 0.3s ease;
        }
        
        .form-input:focus {
            background: rgba(255, 255, 255, 1);
            border-color: var(--primary-blue);
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
        }
        
        .progress-bar {
            background: linear-gradient(90deg, var(--primary-blue) 0%, var(--accent-green) 100%);
            transition: width 0.5s ease;
        }
        
        .pdf-viewer {
            background: #f8fafc;
            border: 2px dashed #cbd5e1;
            min-height: 600px;
        }
        
        .pdf-viewer.has-pdf {
            border-style: solid;
            border-color: var(--primary-blue);
        }
        
        .step-indicator {
            position: relative;
        }
        
        .step-indicator::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 100%;
            width: 100px;
            height: 2px;
            background: #e5e7eb;
            transform: translateY(-50%);
        }
        
        .step-indicator.completed::after {
            background: var(--accent-green);
        }
        
        .step-indicator:last-child::after {
            display: none;
        }
        
        .floating-customer-info {
            position: sticky;
            top: 100px;
            z-index: 40;
        }
        
        .autosave-indicator {
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
    </style>
</head>
<body class="bg-gray-50">
    <!-- Navigation -->
    <nav class="glass-effect fixed top-0 left-0 right-0 z-50 px-6 py-4">
        <div class="max-w-7xl mx-auto flex items-center justify-between">
            <div class="flex items-center space-x-4">
                <a href="index.html" class="flex items-center space-x-2 text-white hover:text-blue-200 transition-colors">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path>
                    </svg>
                    <span>Zurück</span>
                </a>
                <div class="w-10 h-10 bg-white rounded-lg flex items-center justify-center">
                    <svg class="w-6 h-6 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                    </svg>
                </div>
                <h1 class="text-xl font-bold text-white">Formular ausfüllen</h1>
            </div>
            
            <div class="flex items-center space-x-4">
                <div class="hidden md:flex items-center space-x-2 text-white">
                    <span class="text-sm">Fortschritt:</span>
                    <div class="w-32 h-2 bg-white bg-opacity-30 rounded-full">
                        <div id="progress-bar" class="progress-bar h-full rounded-full" style="width: 0%"></div>
                    </div>
                    <span id="progress-text" class="text-sm font-medium">0%</span>
                </div>
                
                <div class="flex items-center space-x-2">
                    <div id="autosave-indicator" class="hidden text-white text-sm autosave-indicator">
                        <svg class="w-4 h-4 inline mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                        </svg>
                        Gespeichert
                    </div>
                    <button id="save-btn" class="bg-white text-blue-600 px-4 py-2 rounded-lg font-medium hover:bg-blue-50 transition-colors">
                        Speichern
                    </button>
                </div>
            </div>
        </div>
    </nav>
    
    <!-- Customer Info Bar -->
    <div id="customer-info-bar" class="floating-customer-info glass-effect mx-6 mt-20 mb-6 rounded-xl p-4 hidden">
        <div class="flex items-center justify-between">
            <div class="flex items-center space-x-4">
                <div class="w-12 h-12 bg-blue-500 rounded-full flex items-center justify-center">
                    <span id="customer-initials" class="text-white font-semibold">--</span>
                </div>
                <div>
                    <h3 id="customer-name" class="text-lg font-semibold text-white">Kein Kunde ausgewählt</h3>
                    <p id="customer-details" class="text-blue-100 text-sm">Bitte wählen Sie einen Kunden aus der Übersicht</p>
                </div>
            </div>
            <div class="text-right">
                <div class="text-white text-sm">
                    <span class="font-medium">Versicherungsnummer:</span>
                    <span id="customer-insurance">--</span>
                </div>
                <div class="text-blue-100 text-sm">
                    <span class="font-medium">Pflegegrad:</span>
                    <span id="customer-care-level">--</span>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Main Content -->
    <main class="max-w-7xl mx-auto px-6 pb-12">
        <!-- Step Indicator -->
        <div class="mb-8">
            <div class="glass-effect rounded-xl p-6">
                <div class="flex items-center justify-between">
                    <div class="step-indicator flex items-center space-x-2" data-step="1">
                        <div class="w-8 h-8 bg-blue-600 text-white rounded-full flex items-center justify-center font-semibold text-sm">1</div>
                        <span class="text-white font-medium">Kundendaten</span>
                    </div>
                    <div class="step-indicator flex items-center space-x-2" data-step="2">
                        <div class="w-8 h-8 bg-gray-400 text-white rounded-full flex items-center justify-center font-semibold text-sm">2</div>
                        <span class="text-gray-300">Pflegebedarf</span>
                    </div>
                    <div class="step-indicator flex items-center space-x-2" data-step="3">
                        <div class="w-8 h-8 bg-gray-400 text-white rounded-full flex items-center justify-center font-semibold text-sm">3</div>
                        <span class="text-gray-300">Gesundheitszustand</span>
                    </div>
                    <div class="step-indicator flex items-center space-x-2" data-step="4">
                        <div class="w-8 h-8 bg-gray-400 text-white rounded-full flex items-center justify-center font-semibold text-sm">4</div>
                        <span class="text-gray-300">Abschluss</span>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Form and PDF Viewer -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
            <!-- Form Section -->
            <div class="space-y-6">
                <!-- Step 1: Customer Data -->
                <div id="step-1" class="form-section rounded-xl p-6 active">
                    <h2 class="text-xl font-bold text-gray-800 mb-6">Persönliche Angaben</h2>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Vorname *</label>
                            <input type="text" id="vorname" class="form-input w-full px-4 py-3 rounded-lg border-0" required>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Nachname *</label>
                            <input type="text" id="nachname" class="form-input w-full px-4 py-3 rounded-lg border-0" required>
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Geburtsdatum *</label>
                            <input type="date" id="geburtsdatum" class="form-input w-full px-4 py-3 rounded-lg border-0" required>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Versicherungsnummer</label>
                            <input type="text" id="versicherungsnummer" class="form-input w-full px-4 py-3 rounded-lg border-0">
                        </div>
                    </div>
                    
                    <div class="mt-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Adresse *</label>
                        <input type="text" id="adresse" class="form-input w-full px-4 py-3 rounded-lg border-0" required>
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">PLZ *</label>
                            <input type="text" id="plz" class="form-input w-full px-4 py-3 rounded-lg border-0" required>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Ort *</label>
                            <input type="text" id="ort" class="form-input w-full px-4 py-3 rounded-lg border-0" required>
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Telefon</label>
                            <input type="tel" id="telefon" class="form-input w-full px-4 py-3 rounded-lg border-0">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Email</label>
                            <input type="email" id="email" class="form-input w-full px-4 py-3 rounded-lg border-0">
                        </div>
                    </div>
                </div>
                
                <!-- Step 2: Care Needs -->
                <div id="step-2" class="form-section rounded-xl p-6 hidden">
                    <h2 class="text-xl font-bold text-gray-800 mb-6">Pflegebedarf</h2>
                    
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Pflegegrad</label>
                            <select id="pflegegrad" class="form-input w-full px-4 py-3 rounded-lg border-0">
                                <option value="">Bitte auswählen</option>
                                <option value="Pflegegrad 1">Pflegegrad 1</option>
                                <option value="Pflegegrad 2">Pflegegrad 2</option>
                                <option value="Pflegegrad 3">Pflegegrad 3</option>
                                <option value="Pflegegrad 4">Pflegegrad 4</option>
                                <option value="Pflegegrad 5">Pflegegrad 5</option>
                            </select>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Art der Pflege</label>
                            <div class="space-y-2">
                                <label class="flex items-center">
                                    <input type="checkbox" id="pflegeart_ambulant" class="mr-2">
                                    <span>Ambulante Pflege</span>
                                </label>
                                <label class="flex items-center">
                                    <input type="checkbox" id="pflegeart_stationaer" class="mr-2">
                                    <span>Stationäre Pflege</span>
                                </label>
                                <label class="flex items-center">
                                    <input type="checkbox" id="pflegeart_teilzeit" class="mr-2">
                                    <span>Teilstationäre Pflege</span>
                                </label>
                            </div>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Häufigkeit der Pflege</label>
                            <select id="pflegehaeufigkeit" class="form-input w-full px-4 py-3 rounded-lg border-0">
                                <option value="">Bitte auswählen</option>
                                <option value="täglich">Täglich</option>
                                <option value="mehrmals wöchentlich">Mehrmals wöchentlich</option>
                                <option value="wöchentlich">Wöchentlich</option>
                                <option value="monatlich">Monatlich</option>
                            </select>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Besondere Hinweise</label>
                            <textarea id="pflege_hinweise" rows="3" class="form-input w-full px-4 py-3 rounded-lg border-0" placeholder="Besondere Hinweise zum Pflegebedarf..."></textarea>
                        </div>
                    </div>
                </div>
                
                <!-- Step 3: Health Status -->
                <div id="step-3" class="form-section rounded-xl p-6 hidden">
                    <h2 class="text-xl font-bold text-gray-800 mb-6">Gesundheitszustand</h2>
                    
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Allgemeiner Gesundheitszustand</label>
                            <select id="gesundheitszustand" class="form-input w-full px-4 py-3 rounded-lg border-0">
                                <option value="">Bitte auswählen</option>
                                <option value="gut">Gut</option>
                                <option value="befriedigend">Befriedigend</option>
                                <option value="schlecht">Schlecht</option>
                                <option value="sehr schlecht">Sehr schlecht</option>
                            </select>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Mobilität</label>
                            <select id="mobilitaet" class="form-input w-full px-4 py-3 rounded-lg border-0">
                                <option value="">Bitte auswählen</option>
                                <option value="uneingeschränkt">Uneingeschränkt</option>
                                <option value="leicht eingeschränkt">Leicht eingeschränkt</option>
                                <option value="stark eingeschränkt">Stark eingeschränkt</option>
                                <option value="bettlägerig">Bettlägerig</option>
                            </select>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Kognitive Fähigkeiten</label>
                            <select id="kognition" class="form-input w-full px-4 py-3 rounded-lg border-0">
                                <option value="">Bitte auswählen</option>
                                <option value="unbeeinträchtigt">Unbeeinträchtigt</option>
                                <option value="leicht beeinträchtigt">Leicht beeinträchtigt</option>
                                <option value="stark beeinträchtigt">Stark beeinträchtigt</option>
                                <option value="nicht vorhanden">Nicht vorhanden</option>
                            </select>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Medikamente</label>
                            <textarea id="medikamente" rows="3" class="form-input w-full px-4 py-3 rounded-lg border-0" placeholder="Aktuelle Medikamente und Dosierungen..."></textarea>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Allergien</label>
                            <textarea id="allergien" rows="2" class="form-input w-full px-4 py-3 rounded-lg border-0" placeholder="Bekannte Allergien..."></textarea>
                        </div>
                    </div>
                </div>
                
                <!-- Step 4: Completion -->
                <div id="step-4" class="form-section rounded-xl p-6 hidden">
                    <h2 class="text-xl font-bold text-gray-800 mb-6">Abschluss</h2>
                    
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Prüfungsdatum</label>
                            <input type="date" id="pruefungsdatum" class="form-input w-full px-4 py-3 rounded-lg border-0" value="">
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Prüfer</label>
                            <input type="text" id="pruefer" class="form-input w-full px-4 py-3 rounded-lg border-0" placeholder="Name des Prüfers">
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Bemerkungen</label>
                            <textarea id="bemerkungen" rows="4" class="form-input w-full px-4 py-3 rounded-lg border-0" placeholder="Allgemeine Bemerkungen zur Prüfung..."></textarea>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Nächste Prüfung</label>
                            <input type="date" id="naechste_pruefung" class="form-input w-full px-4 py-3 rounded-lg border-0">
                        </div>
                    </div>
                </div>
                
                <!-- Navigation Buttons -->
                <div class="flex justify-between mt-6">
                    <button id="prev-btn" class="bg-gray-500 text-white px-6 py-3 rounded-lg font-medium hover:bg-gray-600 transition-colors hidden">
                        ← Zurück
                    </button>
                    <div class="flex-1"></div>
                    <button id="next-btn" class="bg-blue-600 text-white px-6 py-3 rounded-lg font-medium hover:bg-blue-700 transition-colors">
                        Weiter →
                    </button>
                </div>
            </div>
            
            <!-- PDF Viewer -->
            <div class="lg:sticky lg:top-24">
                <div class="glass-effect rounded-xl p-6">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="text-lg font-semibold text-white">PDF-Vorschau</h3>
                        <div class="flex space-x-2">
                            <button id="refresh-pdf" class="bg-white bg-opacity-20 text-white px-3 py-1 rounded text-sm hover:bg-opacity-30 transition-colors">
                                Aktualisieren
                            </button>
                            <button id="download-pdf" class="bg-green-600 text-white px-3 py-1 rounded text-sm hover:bg-green-700 transition-colors">
                                Download
                            </button>
                        </div>
                    </div>
                    
                    <div id="pdf-viewer" class="pdf-viewer rounded-lg p-4 flex items-center justify-center">
                        <div class="text-center text-gray-500">
                            <svg class="w-16 h-16 mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                            </svg>
                            <p>PDF-Vorschau wird geladen...</p>
                            <p class="text-sm mt-2">Automatische Aktualisierung bei Eingaben</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>
    
    <!-- Footer -->
    <footer class="bg-gray-900 text-white py-8 mt-16">
        <div class="max-w-7xl mx-auto px-6 text-center">
            <p class="text-gray-400">&copy; 2024 Pflegedienst Digital. Alle Rechte vorbehalten.</p>
        </div>
    </footer>
    
    <!-- Loading Overlay -->
    <div id="loading-overlay" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-lg p-6 text-center">
            <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mx-auto mb-4"></div>
            <p class="text-gray-700">PDF wird generiert...</p>
        </div>
    </div>
    
    <!-- Scripts -->
    <script src="config.js"></script>
    <script src="main.js"></script>
    
    <script>
        // Formular-specific functionality
        class FormularManager {
            constructor() {
                this.currentStep = 1;
                this.totalSteps = 4;
                this.formData = {};
                this.customerData = null;
                this.autoSaveTimer = null;
                
                this.init();
            }
            
            init() {
                this.loadCustomerData();
                this.setupEventListeners();
                this.setCurrentDate();
                this.updateProgress();
                
                // Auto-save every 30 seconds
                this.startAutoSave();
            }
            
            loadCustomerData() {
                // Try to get customer data from sessionStorage
                const customerData = sessionStorage.getItem('selectedCustomer');
                
                if (customerData) {
                    this.customerData = JSON.parse(customerData);
                    this.displayCustomerInfo();
                    this.preFillForm();
                } else {
                    // Show message to select customer
                    this.showCustomerSelectionMessage();
                }
            }
            
            displayCustomerInfo() {
                if (!this.customerData) return;
                
                const infoBar = document.getElementById('customer-info-bar');
                const initials = document.getElementById('customer-initials');
                const name = document.getElementById('customer-name');
                const details = document.getElementById('customer-details');
                const insurance = document.getElementById('customer-insurance');
                const careLevel = document.getElementById('customer-care-level');
                
                if (infoBar) infoBar.classList.remove('hidden');
                
                // Set initials
                const nameParts = this.customerData.name.split(' ');
                const initialsText = nameParts.map(part => part[0]).join('').toUpperCase();
                if (initials) initials.textContent = initialsText;
                
                // Set name
                if (name) name.textContent = this.customerData.name;
                
                // Set details
                if (details) details.textContent = `${this.customerData.address}, ${this.customerData.zipCode} ${this.customerData.city}`;
                
                // Set insurance number
                if (insurance) insurance.textContent = this.customerData.insuranceNumber || '--';
                
                // Set care level
                if (careLevel) careLevel.textContent = this.customerData.careLevel || '--';
            }
            
            preFillForm() {
                if (!this.customerData) return;
                
                // Pre-fill form fields with customer data
                const fieldMappings = {
                    'vorname': this.customerData.firstName,
                    'nachname': this.customerData.lastName,
                    'geburtsdatum': this.formatDateForInput(this.customerData.birthDate),
                    'versicherungsnummer': this.customerData.insuranceNumber,
                    'adresse': this.customerData.address,
                    'plz': this.customerData.zipCode,
                    'ort': this.customerData.city,
                    'telefon': this.customerData.phone,
                    'email': this.customerData.email,
                    'pflegegrad': this.customerData.careLevel
                };
                
                Object.keys(fieldMappings).forEach(fieldId => {
                    const field = document.getElementById(fieldId);
                    if (field && fieldMappings[fieldId]) {
                        field.value = fieldMappings[fieldId];
                        this.formData[fieldId] = fieldMappings[fieldId];
                    }
                });
                
                // Trigger PDF update
                this.updatePDFPreview();
            }
            
            formatDateForInput(dateString) {
                if (!dateString) return '';
                
                try {
                    // Handle German date format (DD.MM.YYYY)
                    if (dateString.includes('.')) {
                        const parts = dateString.split('.');
                        if (parts.length === 3) {
                            return `${parts[2]}-${parts[1].padStart(2, '0')}-${parts[0].padStart(2, '0')}`;
                        }
                    }
                    
                    // Handle ISO date format
                    const date = new Date(dateString);
                    return date.toISOString().split('T')[0];
                } catch (error) {
                    console.warn('Could not format date:', dateString);
                    return '';
                }
            }
            
            showCustomerSelectionMessage() {
                const infoBar = document.getElementById('customer-info-bar');
                if (infoBar) {
                    infoBar.classList.remove('hidden');
                    document.getElementById('customer-name').textContent = 'Kein Kunde ausgewählt';
                    document.getElementById('customer-details').textContent = 'Bitte wählen Sie einen Kunden aus der Übersicht aus';
                }
            }
            
            setupEventListeners() {
                // Step navigation
                document.getElementById('next-btn').addEventListener('click', () => this.nextStep());
                document.getElementById('prev-btn').addEventListener('click', () => this.prevStep());
                
                // Form inputs
                const inputs = document.querySelectorAll('input, select, textarea');
                inputs.forEach(input => {
                    input.addEventListener('input', (e) => this.handleInputChange(e));
                    input.addEventListener('blur', () => this.validateField(input));
                });
                
                // PDF actions
                document.getElementById('refresh-pdf').addEventListener('click', () => this.updatePDFPreview());
                document.getElementById('download-pdf').addEventListener('click', () => this.downloadPDF());
                
                // Save button
                document.getElementById('save-btn').addEventListener('click', () => this.saveForm());
            }
            
            handleInputChange(event) {
                const { id, value, type, checked } = event.target;
                
                if (type === 'checkbox') {
                    this.formData[id] = checked;
                } else {
                    this.formData[id] = value;
                }
                
                // Trigger auto-save
                this.triggerAutoSave();
                
                // Update PDF preview (debounced)
                clearTimeout(this.pdfUpdateTimer);
                this.pdfUpdateTimer = setTimeout(() => {
                    this.updatePDFPreview();
                }, 1000);
            }
            
            validateField(field) {
                const isRequired = field.hasAttribute('required');
                const isEmpty = !field.value.trim();
                
                if (isRequired && isEmpty) {
                    field.classList.add('border-red-500');
                    return false;
                } else {
                    field.classList.remove('border-red-500');
                    return true;
                }
            }
            
            nextStep() {
                if (this.currentStep < this.totalSteps) {
                    if (this.validateCurrentStep()) {
                        this.currentStep++;
                        this.updateStepDisplay();
                        this.updateProgress();
                    }
                }
            }
            
            prevStep() {
                if (this.currentStep > 1) {
                    this.currentStep--;
                    this.updateStepDisplay();
                    this.updateProgress();
                }
            }
            
            validateCurrentStep() {
                const currentStepElement = document.getElementById(`step-${this.currentStep}`);
                const requiredFields = currentStepElement.querySelectorAll('[required]');
                let isValid = true;
                
                requiredFields.forEach(field => {
                    if (!this.validateField(field)) {
                        isValid = false;
                    }
                });
                
                if (!isValid) {
                    window.app.showNotification('Bitte füllen Sie alle Pflichtfelder aus.', 'warning');
                }
                
                return isValid;
            }
            
            updateStepDisplay() {
                // Hide all steps
                for (let i = 1; i <= this.totalSteps; i++) {
                    const step = document.getElementById(`step-${i}`);
                    const indicator = document.querySelector(`[data-step="${i}"]`);
                    
                    if (step) {
                        step.classList.add('hidden');
                        step.classList.remove('active');
                    }
                    
                    if (indicator) {
                        const circle = indicator.querySelector('div');
                        const text = indicator.querySelector('span');
                        
                        if (i < this.currentStep) {
                            // Completed step
                            circle.classList.remove('bg-gray-400', 'bg-blue-600');
                            circle.classList.add('bg-green-500');
                            text.classList.remove('text-gray-300');
                            text.classList.add('text-green-300');
                            indicator.classList.add('completed');
                        } else if (i === this.currentStep) {
                            // Current step
                            circle.classList.remove('bg-gray-400', 'bg-green-500');
                            circle.classList.add('bg-blue-600');
                            text.classList.remove('text-gray-300');
                            text.classList.add('text-white');
                            indicator.classList.remove('completed');
                        } else {
                            // Future step
                            circle.classList.remove('bg-blue-600', 'bg-green-500');
                            circle.classList.add('bg-gray-400');
                            text.classList.remove('text-white', 'text-green-300');
                            text.classList.add('text-gray-300');
                            indicator.classList.remove('completed');
                        }
                    }
                }
                
                // Show current step
                const currentStep = document.getElementById(`step-${this.currentStep}`);
                if (currentStep) {
                    currentStep.classList.remove('hidden');
                    currentStep.classList.add('active');
                }
                
                // Update navigation buttons
                const prevBtn = document.getElementById('prev-btn');
                const nextBtn = document.getElementById('next-btn');
                
                if (prevBtn) {
                    if (this.currentStep === 1) {
                        prevBtn.classList.add('hidden');
                    } else {
                        prevBtn.classList.remove('hidden');
                    }
                }
                
                if (nextBtn) {
                    if (this.currentStep === this.totalSteps) {
                        nextBtn.textContent = 'PDF Generieren';
                        nextBtn.onclick = () => this.generatePDF();
                    } else {
                        nextBtn.textContent = 'Weiter →';
                        nextBtn.onclick = () => this.nextStep();
                    }
                }
            }
            
            updateProgress() {
                const progress = (this.currentStep / this.totalSteps) * 100;
                const progressBar = document.getElementById('progress-bar');
                const progressText = document.getElementById('progress-text');
                
                if (progressBar) {
                    progressBar.style.width = `${progress}%`;
                }
                
                if (progressText) {
                    progressText.textContent = `${Math.round(progress)}%`;
                }
            }
            
            setCurrentDate() {
                const today = new Date().toISOString().split('T')[0];
                const pruefungsdatum = document.getElementById('pruefungsdatum');
                if (pruefungsdatum) {
                    pruefungsdatum.value = today;
                    this.formData.pruefungsdatum = today;
                }
            }
            
            startAutoSave() {
                // Save form data every 30 seconds
                setInterval(() => {
                    this.saveForm();
                }, 30000);
            }
            
            triggerAutoSave() {
                // Clear existing timer
                if (this.autoSaveTimer) {
                    clearTimeout(this.autoSaveTimer);
                }
                
                // Set new timer
                this.autoSaveTimer = setTimeout(() => {
                    this.saveForm();
                }, 2000);
            }
            
            saveForm() {
                // Save to localStorage
                const saveData = {
                    customerData: this.customerData,
                    formData: this.formData,
                    currentStep: this.currentStep,
                    timestamp: new Date().toISOString()
                };
                
                localStorage.setItem('formular-save', JSON.stringify(saveData));
                
                // Show save indicator
                this.showAutoSaveIndicator();
            }
            
            showAutoSaveIndicator() {
                const indicator = document.getElementById('autosave-indicator');
                if (indicator) {
                    indicator.classList.remove('hidden');
                    setTimeout(() => {
                        indicator.classList.add('hidden');
                    }, 2000);
                }
            }
            
            async updatePDFPreview() {
                if (!this.customerData || !window.pdfManager) return;
                
                try {
                    const viewer = document.getElementById('pdf-viewer');
                    viewer.classList.add('has-pdf');
                    
                    // For demo purposes, show a preview message
                    viewer.innerHTML = `
                        <div class="text-center text-gray-600">
                            <svg class="w-12 h-12 mx-auto mb-3 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                            </svg>
                            <p class="font-medium">PDF-Vorschau</p>
                            <p class="text-sm mt-1">Formular wird automatisch aktualisiert</p>
                            <div class="mt-3 text-xs text-gray-500">
                                <div>Kunde: ${this.customerData.name}</div>
                                <div>Stand: ${new Date().toLocaleTimeString()}</div>
                            </div>
                        </div>
                    `;
                    
                } catch (error) {
                    console.error('Error updating PDF preview:', error);
                }
            }
            
            async generatePDF() {
                if (!this.validateCurrentStep()) return;
                
                try {
                    window.app.showLoading('PDF wird generiert...');
                    
                    // Combine customer data and form data
                    const completeData = {
                        ...this.customerData,
                        ...this.formData
                    };
                    
                    // Generate PDF using PDFManager
                    await window.pdfManager.generatePDF(completeData, this.formData);
                    
                    window.app.hideLoading();
                    window.app.showNotification('PDF erfolgreich generiert!', 'success');
                    
                } catch (error) {
                    window.app.hideLoading();
                    console.error('Error generating PDF:', error);
                    window.app.showNotification('Fehler beim Generieren des PDFs: ' + error.message, 'error');
                }
            }
            
            downloadPDF() {
                this.generatePDF();
            }
        }
        
        // Initialize formular manager when DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            // Wait for main app to be initialized
            setTimeout(() => {
                window.formularManager = new FormularManager();
            }, 100);
        });
    </script>
</body>
</html>